package Test
import PlayerHelper
import PlayerUnitHelper
import PlayerUnit
import BossHelper
import UnitObjEditing
import ExternalDefines
import Camera

function test()
    flashEffect(GetEventPlayerChatString(), GetTriggerPlayer().get_unit().getPos())
    
    
    
function clear2()
    print("clear stable")
    Player(0).get_unit().remove_buff(BuffClearType.stable, BuffType.buffs)

function clear1()
    print("clear addition")
    Player(0).get_unit().remove_buff(BuffClearType.additions, BuffType.buffs)
    
@compiletime
function create_fire_chicken()
    var ed = new UnitDefinition('frck', 'nech')
    ed..setNormalAbilities("")
        ..setCollisionSize(80)
        ..setScalingValue(4)
        ..setSpeedBase(0)
        ..setTurnRate(3)
        ..setArmorType(ArmorType.Hero)
        ..setAttacksEnabled(0)
        ..setHitPointsMaximumBase(10000)
        ..setHitPointsRegenerationRate(10000.)
        ..setHitPointsRegenerationType("always")
        ..setName("火鸡")

function displaydamage()
    if GetEventDamage() > -0.000001 and GetEventDamage() < 0.000001
        return 
    unit u = GetTriggerUnit()
    unit pu = GetEventDamageSource()
    player p = pu.getOwner()
    
    real speed = 64 * 0.071 / 128
    real angle = GetRandomReal(15., 165.)
    createTTEx(u.getPos3with(30), GetEventDamage().toString(), 9, p.getColor().toColor().withAlpha(255))
        ..setPermanent(false)
        ..setFadepoint(2.)
        ..setLifespan(3.)
        ..setVelocity(speed * CosBJ(angle), speed * SinBJ(angle))
    
function ms()
    printTimedToPlayer(GetTriggerPlayer().get_unit().getMoveSpeed().toString(1), 4, GetTriggerPlayer()) 

function cam()
    GetTriggerPlayer()..setCameraField(CAMERA_FIELD_FIELD_OF_VIEW, 95., 0)
        ..setCameraField(CAMERA_FIELD_TARGET_DISTANCE, 2500., 0)

function refresh()
    (PlayerUnitHelper.get_instance(GetTriggerPlayer().get_unit()) castTo PlayerUnit).refresh()

init
    unit fire_chicken = createUnit(Player(8), 'frck', BORN_RECT.getCenter() + vec2(0, 500), angle(270))
    CreateTrigger()..registerUnitEvent(fire_chicken, EVENT_UNIT_DAMAGED)
        ..addAction(function displaydamage)
    var tr = CreateTrigger()
    for i = 0 to PLAYER_NUM-1
        tr.registerPlayerChatEvent(Player(i), "", true)
    tr..addAction(function test)
        ..enable()

    var tr1 = CreateTrigger()
    for i = 0 to PLAYER_NUM-1
        tr1.registerPlayerChatEvent(Player(i), "-clear2", true)
    tr1..addAction(function clear2)
        ..enable()

    var tr2 = CreateTrigger()
    var refresh = CreateTrigger()
    for i = 0 to PLAYER_NUM-1
        tr2.registerPlayerChatEvent(Player(i), "-clear1", true)
        refresh.registerPlayerChatEvent(Player(i), "-refresh", true)
    tr2..addAction(function clear1)
        ..enable()
    refresh..addAction(function refresh)

    trigger spd = CreateTrigger()
    trigger cam = CreateTrigger()

    for i = 0 to PLAYER_NUM-1
        spd.registerPlayerChatEvent(Player(i), "ms", true)
        cam.registerPlayerChatEvent(Player(i), "cam", true)
    spd..addAction(function ms)
        
    cam..addAction(function cam)

    
    
    BossHelper.create_boss(fire_chicken, 0)
    BossHelper.register_counter()
    BossHelper.cur_boss = fire_chicken